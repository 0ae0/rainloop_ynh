# Exit on command errors and treat unset variables as an error
set -eu
app=$YNH_APP_INSTANCE_NAME

# Source app helpers
. /usr/share/yunohost/helpers

# Retrieve arguments
	domain=$(ynh_app_setting_get "$app" domain)
	path=$(ynh_app_setting_get "$app" path)
	is_public=$(ynh_app_setting_get "$app" is_public)
	password=$(ynh_app_setting_get "$app" password)
	ldap=$(ynh_app_setting_get "$app" ldap)
	lang=$(ynh_app_setting_get "$app" lang)
	dp_pwd=$(ynh_app_setting_get "$app" mysqlpwd)
	db_user=$app
	plugins=$(ynh_app_setting_get "$app" plugins)

# no update for db now...

# Create the final path and copy sources
	final_path=/var/www/$app
	rainloop_path=${final_path}/app

	# the old version is not deleted... the new version is in a new path

	# Use of latest community edition
	sudo wget -q https://github.com/RainLoop/rainloop-webmail/releases/download/v1.10.2.145/rainloop-community-1.10.2.145-74dc686dd82d9f29b0fef8ceb11c2903.zip
	#Check checksum
	sudo unzip -qq rainloop-community-1.10.2.*.zip -d $rainloop_path/

	# Update patch to auto load version
	sudo cp ../sources/patch/index_auto_version.php $rainloop_path/index.php

	# Update ynh plugins:
	sudo mkdir -p $rainloop_path/data/_data_/_default_/plugins
	sudo cp -rf ../sources/plugins/ynh-login-mapping $rainloop_path/data/_data_/_default_/plugins/.
	sudo cp -rf ../sources/plugins/ynh-ldap-suggestions $rainloop_path/data/_data_/_default_/plugins/.

# update SSO and auto version
	sudo cp ../sources/sso/sso.php                  $final_path/index.php
	sudo cp ../sources/patch/index_auto_version.php $rainloop_path/index.php
	sudo sed -i "s@domain.tld@$domain@g"  $final_path/index.php
	sudo sed -i "s@PATHTOCHANGE@$path@g"  $final_path/index.php

# Set permissions to rainloop directory
	sudo find $final_path/. -type d -exec chmod 755 {} \;
	sudo find $final_path/. -type f -exec chmod 644 {} \;
	sudo chown -R www-data:www-data $final_path

# Update Nginx configuration file
	nginx_conf_file=/etc/nginx/conf.d/$domain.d/$app.conf
	sudo cp ../conf/nginx.conf $nginx_conf_file
	sudo sed -i "s@PATHTOCHANGE@$path@g"         $nginx_conf_file
	sudo sed -i "s@ALIASTOCHANGE@$final_path/@g" $nginx_conf_file
	sudo sed -i "s@NAMETOCHANGE@$app@g"          $nginx_conf_file
	sudo chown root:                             $nginx_conf_file
	sudo chmod 644                               $nginx_conf_file

	finalphpconf=/etc/php5/fpm/pool.d/$app.conf
	sudo cp ../conf/php-fpm.conf        $finalphpconf
	sudo sed -i "s@NAMETOCHANGE@$app@g" $finalphpconf
	sudo chown root:                    $finalphpconf
	sudo chmod 644                      $finalphpconf

# Reload services
	sudo service php5-fpm restart || true
	sudo service nginx reload || true
